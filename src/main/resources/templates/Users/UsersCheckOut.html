<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<html>

<head>
	<title>Cafena - CheckOut</title>
	<header th:replace="_common/scriptClientHeader :: scriptClientHeader">...</header>
	<script src="https://kit.fontawesome.com/99a0617376.js" crossorigin="anonymous"></script>
	<link rel="stylesheet" href="/css/checkout.css">
	<link rel="stylesheet" href="/css/myCheckBox.css" />
	<link rel="stylesheet" href="/css/cssAddOn.css" />

</head>

<body>
	<div th:include="_common/scriptClientHeader :: headerContent" th:remove="tag"></div>
	<main>
		<!-- breadcrumb area start -->
		<section class="breadcrumb-area pt-140 pb-140 bg_img" data-background="/images/bg/breadcrumb-bg-1.jpeg"
			data-overlay="dark" data-opacity="5"
			style="background-image: url(&quot;/images/bg/breadcrumb-bg-1.jpeg&quot;);">
			<div class="shape shape__1"><img src="/images/shape/breadcrumb-shape-1.png" alt=""></div>
			<div class="shape shape__2"><img src="/images/shape/breadcrumb-shape-2.png" alt=""></div>
			<div class="container">
				<div class="row">
					<div class="col-xl-12 text-center">
						<h2 class="page-title">Cafena CheckOut</h2>
						<div class="cafena-breadcrumb breadcrumbs">
							<ul class="list-unstyled d-flex align-items-center justify-content-center">
								<li class="cafenabcrumb-item duxinbcrumb-begin">
									<a href="/"><span>Home</span></a>
								</li>
								<li class="cafenabcrumb-item duxinbcrumb-end">
									<span>Faq</span>
								</li>
							</ul>
						</div>
					</div>
				</div>
			</div>
		</section>
		<div class="cart-area pt-120 pb-120">
			<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
				<div class="toast bg-danger" role="alert" aria-live="assertive" aria-atomic="true" id="toastBorder">
					<div class="d-flex">
						<div class="toast-body" style="color: #ffff;" id="toastText">
							No Products Found,Please Try Back !
						</div>
						<button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"
							aria-label="Close"></button>
					</div>
				</div>
			</div>
			<div class="container">
				<div class="row">
					<div class="col-xl-12">
						<div class="OX-2Lj" style="border-radius: 2%;border: 3px solid ghostwhite;">
							<div class="-p7ULT">
								<div class="vtrWey"></div>
								<div class="_8jJlG8">
									<div class="nU2ylc">
										<div class="MqmqK4">
											<div class="Iafoll"><svg height="16" viewBox="0 0 12 16" width="12"
													class="shopee-svg-icon icon-location-marker">
													<path style="color: #ee4d2d;"
														d="M6 3.2c1.506 0 2.727 1.195 2.727 2.667 0 1.473-1.22 2.666-2.727 2.666S3.273 7.34 3.273 5.867C3.273 4.395 4.493 3.2 6 3.2zM0 6c0-3.315 2.686-6 6-6s6 2.685 6 6c0 2.498-1.964 5.742-6 9.933C1.613 11.743 0 8.498 0 6z"
														fill-rule="evenodd"></path>
												</svg></div>
											<h2 style="color: #ee4d2d;">Address</h2>
										</div>
									</div>
									<div class="Jw2Sc-">
										<div>
											<div class="NYnMjH">
												<div class="FVWWQy"
													th:text="${userAddress.username + ' ' + userAddress.phone}"></div>
												<div class="QsWYfx" th:text="${userAddress.address}" id="ckAddress"
													th:data-id="${userAddress.id}"></div>
												<div class="uk7Wpm" id="defaultAddress">Default</div>
											</div>
										</div><button class="_3WkjWD div-style" id="btnAddress">Change</button>
									</div>
									<div></div>
								</div>
							</div>
						</div>
						<div class="cart-wrapper"
							style="width: 1198px;background: #fff;padding: 0px;height: auto;border-bottom:0px;border-radius: 0px;border: none;">
							<th:block th:each="itSupplier,iters : ${lsSuppliers}">
								<div class="d-flex flex-column" id="cartCheckOut" th:data-id="${itSupplier.id}"
									style="box-shadow: 0 1px 1px 0 rgba(0,0,0,.05);border-radius: 3px;border: 1px solid #E2DFDD; margin-bottom: 20px;">
									<div class="d-flex flex-column p-2 checkHeader" style="height: 80px;">
										<div class="d-flex flex-column ">
											<!-- Block Header -->
											<th:block th:if="${iters.index == 0}">
												<div class="d-flex flew-row p-2">
													<div class="col-6">
														<p class="text-header">Product Name</p>
													</div>
													<div class="col-2">
														<p class="text-header d-flex justify-content-center">Price</p>
													</div>
													<div class="col-2">
														<p class="text-header d-flex justify-content-center">Quantity
														</p>
													</div>
													<div class="col-2">
														<p class="text-header d-flex justify-content-center">Total</p>
													</div>
												</div>
											</th:block>
											<div class="p-2">
												<span style="font-weight: 500;color: #ee4d2d;" id="supplierName"
													th:data-id="${itSupplier.id}"
													th:text="${itSupplier.nameSupplier}"></span>
											</div>
										</div>
									</div>
									<div class="p-2 checkBody">
										<div class="d-flex flex-column">
											<th:block th:each="itCarts,iterc : ${lsCart}">
												<!-- IF PRODUCT -->
												<th:block th:if="${itCarts.idSupplier == itSupplier.id}">
													<div class="d-flex flex-row p-2">
														<div class="col-6 d-flex flew-row">
															<a href="#" class="img col-2"
																style="display: flex;justify-content: center;">
																<img th:src="${itCarts.image}" alt=""
																	style="height: 80px;" class="p-2" onerror="this.onerror=null;this.src='/error/imgError00.jpg'"> </a>
															<p class="col-10 text-ckBody"
																style="align-items: center;display: flex;"
																th:text="${itCarts.productName}">
															</p>
														</div>
														<div class="col-2"
															style="justify-content: center;display: flex;align-items: center;">
															<p class="text-ckBody d-flex justify-content-center"
																th:text="${'$' + itCarts.price / itCarts.amount + '.00'}">
															</p>
														</div>
														<div class="col-2"
															style="justify-content: center;display: flex;align-items: center;">
															<p class="text-ckBody d-flex justify-content-center"
																th:text="${itCarts.amount}"></p>
														</div>
														<div class="col-2"
															style="justify-content: center;display: flex;align-items: center;">
															<p class="text-ckBody d-flex justify-content-center"
																th:data-id="${itSupplier.id}"
																th:data-price="${itCarts.price}"
																th:text="${'$' + itCarts.price + '.00'}"
																id="totalPrice"></p>
														</div>
													</div>
												</th:block>
											</th:block>
										</div>
									</div>
									<div class="p-2"
										style="border: 1px dashed rgba(0,0,0,.09);min-height: 0;min-width: 0;background-color: #fafdff;height: 50px;">
										<div class="d-flex flex-row justify-content-end" style="height: 50px;">
											<div class="col-8"
												style="display: flex;justify-content: right;align-content: center;">
												<i class="fa-solid fa-ticket"
													style="color: #ed745c;left: -9px;position: relative;top: 7px;color: #ed745c;"></i>Voucher
												Shop :</span>
											</div>
											<div class="col-2">
												<p id="voucherSelect" th:data-id="${itSupplier.id}" style="height: 32px;font-size: 16px;display: flex;justify-content: flex-end;
												color: #ee4d2d;" data-price="0" data-idv=""></p>
											</div>
											<div class="col-2"
												style="display: flex;justify-content: center; align-content: center;">
												<span th:data-id="${itSupplier.id}" id="btnChooseVoucher"
													style="cursor: pointer;color: #0055aa;padding-right: 15px;"
													Voucher													data-price="0">Select Vouchers</span>
											</div>
										</div>
									</div>
									<div class="p-2"
										style="border: 1px dashed rgba(0,0,0,.09);min-height: 0;min-width: 0;background-color: #fafdff;height: 50px;">
										<div class="d-flex flex-row justify-content-end">
											<div class="col-8" style="justify-content: flex-end;display: flex;">Total :
											</div>
											<div class="col-4" style="right: 71px;
												position: relative;
												display: flex;
												justify-content: right;
												align-content: center;" id="totalShop" th:data-id="${itSupplier.id}" data-price="0">
											</div>
										</div>
									</div>
								</div>
							</th:block>
							<!-- CheckOut 2 -->

							<!-- Sum -->
							<div class="checkOutSum d-flex flex-column border-ck-out">
								<div class="p-2 d-flex flex-row">
									<p class="col-8 text-sum" style="display: flex;justify-content: right;">Total :</p>
									<p class="col-4 text-sum left-tx-sum" id="totalConsume" data-price="0"></p>
								</div>
								<div class="p-2 d-flex flex-row ">
									<p class="col-8 text-sum" style="display: flex;justify-content: right;">Promotional
										Combos :</p>
									<p class="col-4 text-sum left-tx-sum" id="totalComboVoucher" data-price="0">$0.00
									</p>
								</div>
								<div class="p-2 d-flex flex-row">
									<p class="col-8 text-sum" style="display: flex;justify-content: right;">Total
										Discount Vouchers:</p>
									<th:block th:if="${voucherAdmin != null}">
										<p class="col-4 text-sum left-tx-sum" th:data-id="${voucherAdmin.id}"
											id="voucherAdmin" th:data-price="${voucherAdmin.discount}"
											th:text="${'- $' +voucherAdmin.discount + '.00'}"></p>
									</th:block>
									<th:block th:if="${voucherAdmin == null}">
										<p class="col-4 text-sum left-tx-sum" data-id="BLANK" id="voucherAdmin"
											data-price="0">$0.00</p>
									</th:block>
								</div>
								<div class="p-2 d-flex flex-row ">
									<p class="col-8 text-sum" style="display: flex;justify-content: right;">Fee Services :</p>
									<p class="col-4 text-sum left-tx-sum" id="feeService" data-price="0">$0.00
									</p>
								</div>
								<div class="p-2 d-flex flex-row total-fn-ck">
									<p class="col-8 text-sum" style="display: flex;justify-content: right;">Total
										payment:</p>
									<p class="col-4 text-sum left-tx-sum" id="totalFinal" data-price="0"></p>
								</div>
								<div class="p-2 d-flex flex-row total-fn-ck justify-content-end">
									<button style="border-radius:5px;margin-right:  11px;height: 36px;width: 200px;color: white;background-color: #ee4d2d;" id="btnPayment"
									>Payment</button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
	</main>
	<!-- Popup -->
	<div class="popup-address product-popup product-popup-1">
		<div id="contentPopup">

		</div>
	</div>


	<div th:include="_common/scriptClientFooter :: scriptClientFooter" th:remove="tag"></div>
	<script src="https://code.jquery.com/jquery-3.7.0.js"
		integrity="sha256-JlqSTELeR4TLqP0OG9dxM7yDPqX1ox/HfgiSLBj8+kM=" crossorigin="anonymous"></script>

	<script>
		$("#btnAddress").on('click', function (e) {
			e.preventDefault();
			$.ajax({
				async: false,
				cache: false,
				url: "/Account/ajax/getUserAddress",
			}).done(function (data) {
				$('#contentPopup').html(data);
			})
			$('.overlay, .product-popup-1').addClass('show-popup');
		});

		$(document).ready(function () {
			totalFirstLoad();
			//
			$('span[id="btnChooseVoucher"]').on('click', function (e) {
				e.preventDefault();
				var id = $(this).attr('data-id');
				var flagShowVoucher = true;
				//
				$.ajax({
					async: false,
					cache: false,
					url: "/Carts/ajax/getVoucherSupplier",
					data: {
						idSupplier: id,
					}
				}).done(function (data) {
					if(data == "false"){
						displayToastMessage(true, "There Are No Vouchers At This Time");
						flagShowVoucher = false;
					} else {
						$('#contentPopup').html(data);	
					}			
				});
				//
				if(flagShowVoucher) {
					var supplierSelect = $(`span[id="supplierName"][data-id=${id}]`).text();
					$("#nameSupplierVoucher").text(supplierSelect + " Vouchers");
					$("#submitButton").attr('data-id', id);
					$('.overlay, .product-popup-1').addClass('show-popup');
				}
			})

			$('#btnPayment').on('click',function(e){
				e.preventDefault();
				const queryString = window.location.search;
				var strVoucher = "";
				var idUserAddress = $('#ckAddress').attr('data-id');
				var feeService = $('#feeService').attr('data-price');
				//
				$('p[id="voucherSelect"]').each(function(){
					if($(this).attr('data-idv').trim() != ""){
						strVoucher += $(this).attr("data-idv") + ","
					}
				});
				if(strVoucher.trim() == ""){
					strVoucher = "BLANK";
				}else{
					strVoucher = strVoucher.substring(0,strVoucher.length - 1);
				}
				//
				var urlPayment = "/Invoice/InvoicePayment" + queryString + "&lsVoucherS=" + strVoucher + "&idUserAddress=" + idUserAddress + "&feeService=" + feeService;
				window.location.assign(urlPayment);
			})


			function totalFirstLoad() {
				var totalComsume = 0;
				//Voucher Admin
				var voucherAdmin = $('#voucherAdmin').attr('data-price');
				//
				$("div[id='cartCheckOut']").each(function () {
					var totalCurrent = 0;
					//
					$(`p[id='totalPrice'][data-id='${$(this).attr('data-id')}']`).each(function () {
						totalCurrent += parseInt($(this).attr('data-price'));
					})
					//
					$(`div[id='totalShop'][data-id='${$(this).attr('data-id')}'`).text('$' + totalCurrent + '.00');
					$(`div[id='totalShop'][data-id='${$(this).attr('data-id')}'`).attr('data-price', totalCurrent);
					totalComsume += totalCurrent;
				})
				$('#totalConsume').text('$' + totalComsume + '.00');
				$('#totalConsume').attr('data-price', totalComsume);
				caculationFeeService();
				//feeService
				var feeService = parseFloat($('#feeService').attr('data-price'));
				$('#totalFinal').text('$' + parseFloat(totalComsume - voucherAdmin + feeService).toFixed(2));
			}

			function caculationFeeService(){
				var caculateFee = 0;
				$(`div[id='totalShop']`).each(function(){
					caculateFee += 2 * parseInt($(this).attr('data-price')) / 100;
				});
				caculateFee = parseFloat(caculateFee).toFixed(2)
				$('#feeService').attr('data-price',caculateFee);
				var stringFee = caculateFee.toString();
				$('#feeService').text('$' + caculateFee);
			}
			
			function displayToastMessage(flagDanger, msgDisplay) {
				$('#toastText').toast('hide');
				$('#toastText').text(msgDisplay);
				//
				if (flagDanger == true) {
					$('#toastBorder').addClass('bg-danger');
					$('#toastBorder').removeClass('bg-success');
				} else if (flagDanger == false) {
					$('#toastBorder').addClass('bg-success');
					$('#toastBorder').removeClass('bg-danger');
				}
				//
				$('.toast').toast('show');
			}
		});
	</script>
</body>